stages:
  - test
  - deploy



variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# å•å…ƒæµ‹è¯•é˜¶æ®µ
test:unit:
  stage: test
  image: python:3.12
  tags:
    - docker
  before_script:
    # æ¢æºï¼šä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºåŠ é€Ÿ apt å’Œ pip
    - |
      if [ -f /etc/apt/sources.list.d/debian.sources ]; then
        sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources
      elif [ -f /etc/apt/sources.list ]; then
        sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list
      fi
    - pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
    
    # å®‰è£…ç³»ç»Ÿä¾èµ– (mysqlclient éœ€è¦)
    - apt-get update && apt-get install -y default-libmysqlclient-dev build-essential pkg-config
    # å‡çº§ pip
    - pip install --upgrade pip
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - pip install -r requirements.txt
  script:
    # åˆ›å»ºæŠ¥å‘Šç›®å½•
    - mkdir -p report
    # è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š (HTMLæŠ¥å‘Šå’ŒJUnit XMLæŠ¥å‘Š)
    - pytest unit_test/ --html=report/report.html --self-contained-html --junitxml=report/junit.xml
  artifacts:
    paths:
      - report/
    expire_in: 7 days
    when: always
    reports:
      junit: report/junit.xml
  # å…è®¸å¤±è´¥ï¼ˆå¯é€‰ï¼‰
  # allow_failure: true

# éƒ¨ç½²é˜¶æ®µ - å¼€å‘ç¯å¢ƒ
deploy:dev:
  stage: deploy
  image: docker:28-dind
  tags:
    - docker
  variables:
    APP_CONTAINER_NAME: "skyris-backend-container-dev"
    APP_IMAGE_NAME: "docker-skyris-backend-dev"
    HOST_PORT: "8000"
    APP_VERSION: "latest"
    MYSQL_HOST: "47.100.51.2"
    MYSQL_PORT: "3307"
    MYSQL_DATABASE: "reward_db"
    MYSQL_USER: "reward_user"
    MYSQL_PASSWORD: "reward_passwd"
  script:
    - echo "ğŸš€ å¼€å§‹éƒ¨ç½²å¼€å‘ç¯å¢ƒ..."
    # æ¸…ç†æ—§å®¹å™¨
    - if [ $(docker ps -q -f name=$APP_CONTAINER_NAME) ]; then docker stop $APP_CONTAINER_NAME; fi
    - if [ $(docker ps -aq -f name=$APP_CONTAINER_NAME) ]; then docker rm $APP_CONTAINER_NAME; fi
    
    # æ„å»ºé•œåƒ (ä½¿ç”¨ docker/Dockerfileï¼Œä¸Šä¸‹æ–‡ä¸ºå½“å‰ç›®å½•)
    - docker build -t ${APP_IMAGE_NAME}:${APP_VERSION} -f docker/Dockerfile .
    
    # è¿è¡Œå®¹å™¨
    # æ³¨æ„ï¼šå®é™…éƒ¨ç½²æ—¶å¯èƒ½éœ€è¦æŒ‚è½½ .env æ–‡ä»¶æˆ–ä¼ é€’ç¯å¢ƒå˜é‡
    - docker run -d -p ${HOST_PORT}:8000 --restart always --name ${APP_CONTAINER_NAME} -e "MYSQL_HOST=${MYSQL_HOST}" -e "MYSQL_PORT=${MYSQL_PORT}" -e "MYSQL_DATABASE=${MYSQL_DATABASE}" -e "MYSQL_USER=${MYSQL_USER}" -e "MYSQL_PASSWORD=${MYSQL_PASSWORD}" ${APP_IMAGE_NAME}:${APP_VERSION}
    
  only:
    - develop

# éƒ¨ç½²é˜¶æ®µ - ç”Ÿäº§ç¯å¢ƒ
deploy:prod:
  stage: deploy
  image: docker:28-dind
  tags:
    - docker
  variables:
    APP_CONTAINER_NAME: "skyris-backend-container"
    APP_IMAGE_NAME: "docker-skyris-backend"
    HOST_PORT: "8001" # ç”Ÿäº§ç¯å¢ƒç«¯å£ï¼Œé¿å…å†²çª
    APP_VERSION: "latest"
  script:
    - echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ..."
    - if [ $(docker ps -q -f name=$APP_CONTAINER_NAME) ]; then docker stop $APP_CONTAINER_NAME; fi
    - if [ $(docker ps -aq -f name=$APP_CONTAINER_NAME) ]; then docker rm $APP_CONTAINER_NAME; fi
    
    - docker build -t ${APP_IMAGE_NAME}:${APP_VERSION} -f docker/Dockerfile .
    
    - docker run -d -p ${HOST_PORT}:8000 --restart always --name ${APP_CONTAINER_NAME} ${APP_IMAGE_NAME}:${APP_VERSION}
    
  only:
    - main
  when: manual
