stages:
  - test
  - deploy

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .pip-cache/

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# å•å…ƒæµ‹è¯•é˜¶æ®µ
test:unit:
  stage: test
  image: python:3.12
  tags:
    - docker
  before_script:
    # å®‰è£…ç³»ç»Ÿä¾èµ– (mysqlclient éœ€è¦)
    - apt-get update && apt-get install -y default-libmysqlclient-dev build-essential pkg-config
    # å‡çº§ pip
    - pip install --upgrade pip
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - pip install -r requirements.txt
  script:
    # è¿è¡Œæµ‹è¯•
    - pytest unit_test/
  # å…è®¸å¤±è´¥ï¼ˆå¯é€‰ï¼‰
  # allow_failure: true

# éƒ¨ç½²é˜¶æ®µ - å¼€å‘çŽ¯å¢ƒ
deploy:dev:
  stage: deploy
  image: docker:28-dind
  tags:
    - docker
  variables:
    APP_CONTAINER_NAME: "skyris-backend-container-dev"
    APP_IMAGE_NAME: "docker-skyris-backend-dev"
    HOST_PORT: "8000"
    APP_VERSION: "latest"
  script:
    - echo "ðŸš€ å¼€å§‹éƒ¨ç½²å¼€å‘çŽ¯å¢ƒ..."
    # æ¸…ç†æ—§å®¹å™¨
    - if [ $(docker ps -q -f name=$APP_CONTAINER_NAME) ]; then docker stop $APP_CONTAINER_NAME; fi
    - if [ $(docker ps -aq -f name=$APP_CONTAINER_NAME) ]; then docker rm $APP_CONTAINER_NAME; fi
    
    # æž„å»ºé•œåƒ (ä½¿ç”¨ docker/Dockerfileï¼Œä¸Šä¸‹æ–‡ä¸ºå½“å‰ç›®å½•)
    - docker build -t ${APP_IMAGE_NAME}:${APP_VERSION} -f docker/Dockerfile .
    
    # è¿è¡Œå®¹å™¨
    # æ³¨æ„ï¼šå®žé™…éƒ¨ç½²æ—¶å¯èƒ½éœ€è¦æŒ‚è½½ .env æ–‡ä»¶æˆ–ä¼ é€’çŽ¯å¢ƒå˜é‡
    - docker run -d -p ${HOST_PORT}:8000 --restart always --name ${APP_CONTAINER_NAME} ${APP_IMAGE_NAME}:${APP_VERSION}
    
    # ä¿å­˜é•œåƒ (å¯é€‰)
    - mkdir -p docker/images
    - docker save $APP_IMAGE_NAME:$APP_VERSION > docker/images/${APP_IMAGE_NAME}.tar
  artifacts:
    paths:
      - docker/images/
    expire_in: 3 days
  only:
    - develop

# éƒ¨ç½²é˜¶æ®µ - ç”Ÿäº§çŽ¯å¢ƒ
deploy:prod:
  stage: deploy
  image: docker:28-dind
  tags:
    - docker
  variables:
    APP_CONTAINER_NAME: "skyris-backend-container"
    APP_IMAGE_NAME: "docker-skyris-backend"
    HOST_PORT: "8001" # ç”Ÿäº§çŽ¯å¢ƒç«¯å£ï¼Œé¿å…å†²çª
    APP_VERSION: "latest"
  script:
    - echo "ðŸš€ å¼€å§‹éƒ¨ç½²ç”Ÿäº§çŽ¯å¢ƒ..."
    - if [ $(docker ps -q -f name=$APP_CONTAINER_NAME) ]; then docker stop $APP_CONTAINER_NAME; fi
    - if [ $(docker ps -aq -f name=$APP_CONTAINER_NAME) ]; then docker rm $APP_CONTAINER_NAME; fi
    
    - docker build -t ${APP_IMAGE_NAME}:${APP_VERSION} -f docker/Dockerfile .
    
    - docker run -d -p ${HOST_PORT}:8000 --restart always --name ${APP_CONTAINER_NAME} ${APP_IMAGE_NAME}:${APP_VERSION}
    
    - mkdir -p docker/images
    - docker save $APP_IMAGE_NAME:$APP_VERSION > docker/images/${APP_IMAGE_NAME}.tar
  artifacts:
    paths:
      - docker/images/
    expire_in: 7 days
  only:
    - main
  when: manual
