# 单元测试覆盖文档

本文档基于 `unit_test/` 目录下的测试代码生成，详细记录了当前系统的单元测试覆盖情况。

---

## 1. 用户模块 (User API)
**测试文件**: `unit_test/test_user_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestUserRegistration** | 注册成功 | 用户提供合法的用户名、邮箱、密码和角色 | 状态码 200，返回用户信息，邮箱自动添加后缀 `@skyrisai.com` |
| | 注册重复用户名 | 尝试注册已存在的用户名 | 状态码 400 |
| | 注册无效邮箱 | 尝试注册格式不合法的邮箱 | 状态码 422 (Validation Error) |
| **TestUserLogin** | 登录成功 | 使用正确的用户名和密码登录 | 状态码 200，返回 JWT Token |
| | 登录密码错误 | 使用错误的密码登录 | 状态码 401 |
| | 登录不存在用户 | 使用不存在的用户名登录 | 状态码 401 |
| **TestUserInfo** | 获取当前用户信息 | 携带有效 Token 请求 `/api/user/me` | 状态码 200，返回当前用户信息 |
| | 未授权获取信息 | 不携带 Token 请求 | 状态码 401 |
| | 根据用户名获取信息 | 查询存在的用户名 | 状态码 200，返回指定用户信息 |
| | 获取不存在用户 | 查询不存在的用户名 | 状态码 404 |

---

## 2. 任务模块 (Task API)
**测试文件**: `unit_test/test_task_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestTaskPublish** | 发布任务成功 | 发布者提供合法标题、描述和奖励金额 | 状态码 200，任务状态默认为 `open` |
| | 未授权发布 | 未登录用户尝试发布任务 | 状态码 401 |
| | 发布无效金额任务 | 奖励金额为负数 | 状态码 422 |
| **TestTaskList** | 获取任务列表 | 获取所有任务 | 状态码 200，返回任务列表 |
| | 分页获取任务 | 使用 `skip` 和 `limit` 参数 | 状态码 200，返回指定数量的任务 |
| | 按状态筛选 | 使用 `status` 参数筛选 | 状态码 200，仅返回符合状态的任务 |
| | 任务排序 | 使用 `order_by` 参数 (如 `reward_amount`, `created_at`) | 状态码 200，返回排序后的列表 |
| **TestTaskDetail** | 获取任务详情 | 查询存在的任务 ID | 状态码 200，返回任务详情 |
| | 获取不存在任务 | 查询不存在的任务 ID | 状态码 404 |
| **TestTaskSearch** | 关键词搜索 | 使用 `keyword` 搜索标题或描述 | 状态码 200，返回匹配的任务 |
| | 搜索无结果 | 关键词无匹配项 | 状态码 200，返回空列表 |
| **TestTaskUpdate** | 发布者更新任务 | 发布者更新自己发布的任务 | 状态码 200，更新成功 |
| | 更新任务状态 | 更新任务状态 (如 `in_progress`) | 状态码 200，状态更新成功 |
| | 未授权更新 | 非发布者/管理员尝试更新 | 状态码 403 |
| | 更新不存在任务 | 更新不存在的任务 ID | 状态码 404 |

---

## 3. 奖励模块 (Reward API)
**测试文件**: `unit_test/test_reward_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestRewardIssue** | 发放奖励成功 | 管理员为已完成的任务发放奖励 | 状态码 200，奖励记录创建成功 |
| | 未授权发放 | 非管理员尝试发放奖励 | 状态码 403 |
| **TestRewardDetail** | 获取奖励详情 | 查询存在的奖励 ID | 状态码 200，返回奖励详情 |
| | 获取不存在奖励 | 查询不存在的奖励 ID | 状态码 404 |
| **TestRewardList** | 获取用户奖励列表 | 查询指定用户的奖励记录 | 状态码 200，返回该用户的奖励列表 |
| | 获取空奖励列表 | 用户无奖励记录 | 状态码 200，返回空列表 |
| **TestRewardUpdate** | 更新奖励状态 | 管理员更新奖励状态 (如 `pending` -> `issued`) | 状态码 200，状态更新成功 |
| | 未授权更新 | 非管理员尝试更新 | 状态码 403 |
| | 更新不存在奖励 | 更新不存在的奖励 ID | 状态码 404 |

---

## 4. 任务接取与提交 (Assignment API)
**测试文件**: `unit_test/test_assignment_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestAssignmentAccept** | 接取任务成功 | 用户接取 `open` 状态的任务 | 状态码 200，生成接取记录，触发自动审核(如有) |
| | 重复接取 | 用户尝试接取已接取的任务 | 状态码 400/500 (视具体实现) |
| | 接取自己发布的任务 | 发布者尝试接取自己的任务 | 状态码 400 |
| | 接取非开放任务 | 尝试接取状态非 `open` 的任务 | 状态码 400 |
| **TestAssignmentSubmit** | 提交任务成功 | 用户提交已接取的任务内容 | 状态码 200，状态变更为 `submission_pending` |
| | 提交不存在的任务 | 提交不存在的 Assignment ID | 状态码 404 |
| **TestAssignmentProgress** | 更新进度 | 用户更新任务进度 | 状态码 200 |

---

## 5. 审核模块 (Review API)
**测试文件**: `unit_test/test_review_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestReviewSubmit** | 提交审核成功 | 管理员提交审核结果 (Approved) | 状态码 200，审核记录创建，Assignment 状态更新 |
| | 提交审核拒绝 | 管理员提交审核结果 (Rejected) | 状态码 200，Assignment 状态更新为 Rejected |
| | 未授权审核 | 非管理员尝试提交审核 | 状态码 403 |
| | 审核不存在记录 | 针对不存在的 Assignment 提交审核 | 状态码 404 |
| | 重复审核 | 对同一 Assignment 重复提交审核 | 状态码 400 |
| **TestReviewAppeal** | 申诉审核 | 用户对被拒绝的任务发起申诉 | 状态码 200 |
| | 申诉非本人任务 | 尝试申诉他人的任务 | 状态码 403 |

---

## 6. 通知模块 (Notification API)
**测试文件**: `unit_test/test_notification_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestNotificationSend** | 发送通知成功 | 管理员发送通知给用户 | 状态码 200 |
| | 未授权发送 | 非管理员尝试发送 | 状态码 403 |
| | 发送给不存在用户 | 目标用户不存在 | 状态码 409 |
| **TestNotificationList** | 获取通知列表 | 用户获取自己的通知 | 状态码 200 |
| **TestNotificationRead** | 标记已读 | 用户标记通知为已读 | 状态码 200，`is_read` 变为 True |

---

## 7. 管理员模块 (Admin API)
**测试文件**: `unit_test/test_admin_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestAdminUsers** | 获取用户列表 | 管理员分页获取用户列表 | 状态码 200 |
| | 更新用户角色 | 管理员修改用户角色 | 状态码 200 |
| **TestAdminTasks** | 获取任务列表 | 管理员分页获取所有任务 | 状态码 200 |
| | 更新任务状态 | 管理员强制更新任务状态 | 状态码 200 |
| | 标记风险任务 | 管理员标记任务为风险 (Flag) | 状态码 200 |
| **TestAdminStatistics** | 获取站点统计 | 获取用户、任务、奖励总数 | 状态码 200 |

---

## 8. 用户中心 (User Center API)
**测试文件**: `unit_test/test_user_center_api.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestUserProfile** | 获取个人资料 | 获取当前登录用户详细资料 | 状态码 200 |
| | 更新个人资料 | 更新邮箱等信息 | 状态码 200 |
| **TestUserTasks** | 获取我的任务 | 获取当前用户参与的任务列表 | 状态码 200 |
| **TestUserPublished** | 获取发布任务 | 获取当前用户发布的任务列表 | 状态码 200 |
| **TestUserRewards** | 获取我的奖励 | 获取当前用户的奖励记录 | 状态码 200 |
| **TestUserStatistics** | 获取个人统计 | 获取任务完成数、奖励总额等 | 状态码 200 |

---

## 9. 业务流程测试 (Flow Tests)
**测试文件**: `unit_test/test_assignment_review_flow.py`

| 测试模块 | 测试场景 | 覆盖的业务规则 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TestAcceptanceFlow** | 接取 -> 审核通过 | 完整流程：接取任务 -> 管理员审核通过 -> 任务状态变更 | 流程顺畅，状态流转正确 |
| | 接取 -> 审核拒绝 | 完整流程：接取任务 -> 管理员审核拒绝 -> 任务状态变更 | 流程顺畅，状态流转正确 |
| **TestSubmissionFlow** | 提交 -> 审核通过 | 完整流程：提交任务 -> 管理员审核通过 -> 任务完成 | 流程顺畅，状态流转正确 |
| | 提交 -> 审核拒绝 | 完整流程：提交任务 -> 管理员审核拒绝 -> 任务需重做 | 流程顺畅，状态流转正确 |
| **TestConcurrency** | 并发接取 | 模拟多用户并发接取同一任务 | 验证数据一致性，确保不超发 (Passed with WAL mode) |
| | 并发审核 | 模拟并发审核同一任务 | 验证数据一致性 (Passed with WAL mode) |

---

## 覆盖分析与建议

### 已覆盖的核心边界
1.  **权限控制**: 几乎所有模块都覆盖了 `Unauthorized (401)` 和 `Forbidden (403)` 场景。
2.  **数据存在性**: 覆盖了操作不存在的 User/Task/Assignment/Reward 时的 `404 Not Found`。
3.  **业务逻辑约束**:
    *   任务金额不能为负。
    *   不能接取自己发布的任务。
    *   不能重复接取任务。
    *   不能重复审核。

### 未覆盖或需加强的场景
1.  **文件上传**: 目前 Assignment 提交仅测试了文本内容，未覆盖文件上传 (`UploadFile`) 的测试。
2.  **复杂查询**: 任务搜索和筛选的组合条件测试较少（如同时按关键词、状态、金额范围筛选）。
3.  **软删除**: 目前测试多为物理删除或状态变更，未详细测试软删除逻辑（如果业务有此需求）。
